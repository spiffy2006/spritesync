services:
  web-ui:
    build: ./services/web-ui
    container_name: spritesync-web-ui
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - ORCHESTRATOR_URL=http://orchestrator:4000
    volumes:
      - uploads:/app/uploads
      - configs:/app/configs
      - profiles:/app/profiles
    depends_on:
      - orchestrator
    networks:
      - spritesync-network
    restart: unless-stopped

  orchestrator:
    build: ./services/orchestrator
    container_name: spritesync-orchestrator
    ports:
      - "4000:4000"
    environment:
      - PORT=4000
      - DIARIZATION_URL=http://diarization:5000
      - SPEAKER_ID_URL=http://speaker-id:5001
      - STEM_GENERATOR_URL=http://stem-generator:5002
      - RENDERER_URL=http://renderer:5004
      - MUX_URL=http://mux:5005
    volumes:
      - uploads:/app/uploads:ro
      - cache:/app/cache
    depends_on:
      - diarization
      - speaker-id
      - stem-generator
      - renderer
      - mux
    networks:
      - spritesync-network
    restart: unless-stopped

  diarization:
    build: ./services/diarization
    container_name: spritesync-diarization
    ports:
      - "5010:5000"
    environment:
      - PORT=5000
      - HF_TOKEN=${HF_TOKEN:-}
    volumes:
      - uploads:/app/uploads:ro
      - cache:/app/cache
    networks:
      - spritesync-network
    restart: unless-stopped

  speaker-id:
    build: ./services/speaker-id
    container_name: spritesync-speaker-id
    ports:
      - "5001:5001"
    environment:
      - HF_TOKEN=${HF_TOKEN:-}
    volumes:
      - uploads:/app/uploads:ro
      - profiles:/app/profiles
      - cache:/app/cache
    networks:
      - spritesync-network
    restart: unless-stopped

  stem-generator:
    build: ./services/stem-generator
    container_name: spritesync-stem-generator
    ports:
      - "5002:5002"
    volumes:
      - uploads:/app/uploads:ro
      - cache:/app/cache
    networks:
      - spritesync-network
    restart: unless-stopped

  lipsync:
    build: ./services/lipsync
    container_name: spritesync-lipsync
    volumes:
      - uploads:/app/uploads:ro
    networks:
      - spritesync-network
    restart: unless-stopped

  renderer:
    build: ./services/renderer
    container_name: spritesync-renderer
    ports:
      - "5004:5004"
    volumes:
      - uploads:/app/uploads:ro
      - ./outputs:/app/outputs
    networks:
      - spritesync-network
    restart: unless-stopped
    shm_size: 2gb

  mux:
    build: ./services/mux
    container_name: spritesync-mux
    ports:
      - "5005:5005"
    volumes:
      - uploads:/app/uploads:ro
      - ./outputs:/app/outputs
    networks:
      - spritesync-network
    restart: unless-stopped

volumes:
  uploads:
    driver: local
  configs:
    driver: local
  outputs:
    driver: local
  profiles:
    driver: local
  cache:
    driver: local

networks:
  spritesync-network:
    driver: bridge
